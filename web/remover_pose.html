<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>LocalMediaSuite ‚Äì Remover + Pose</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/styles.css" />
  <script defer src="assets/app.js"></script>
  <style>
    /* Layout-Grundger√ºst (an image.html angelehnt) */
    .page {max-width: 1280px; margin: 0 auto; padding: 18px;}
    .panel {background: #111; border:1px solid #2b2b2b; border-radius: 12px; padding: 16px;}
    .grid-2 {display:grid; grid-template-columns: 1.15fr 1fr; gap: 16px;}
    .row {display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .field {display:grid; gap:6px; min-width: 180px}
    label{font-size:12px; color:#bdbdbd}
    select,input,textarea{background:#1a1a1a; border:1px solid #333; color:#fff; border-radius:10px; padding:8px 10px}
    textarea{min-height:70px}
    .pill{padding:8px 10px; border:1px solid #2b2b2b; background:#141414; border-radius:10px}
    .btn{background:#263241; border:1px solid #334558; color:#e5e7eb; padding:10px 14px; border-radius:10px; cursor:pointer}
    .btn.primary{background:linear-gradient(45deg,#3b82f6,#6366f1); border-color:#3b82f6; font-weight:600}
    .btn.ghost{background:#191919; border-color:#2c2c2c}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    /* Canvas/Preview */
    .board {background:#0b0b0b; border:1px dashed #3a3a3a; border-radius:12px; min-height:520px; position:relative; overflow:hidden}
    .board .placeholder{position:absolute; inset:0; display:grid; place-items:center; color:#6c6c6c}
    .side-note{font-size:12px; color:#909090}
    .chip{padding:6px 10px; border:1px solid #3a3a3a; border-radius:999px; background:#171717; font-size:12px; cursor:pointer}
    .chip.active{border-color:#e91e63; color:#e91e63}
    /* Unterer Toolbar-Bereich bleibt sichtbar */
    .dock {
      position: sticky; bottom: 0; z-index: 5;
      background: #0e0e0eE6; backdrop-filter: blur(6px);
      border: 1px solid #2b2b2b; border-radius: 12px; padding: 10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:12px;
    }
    .tools {display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .seg {display:flex; gap:6px; align-items:center; background:#141414; border:1px solid #2b2b2b; padding:6px; border-radius:10px}
    .seg .tbtn{padding:6px 10px; border-radius:8px; border:1px solid transparent; background:transparent; color:#e5e7eb; cursor:pointer}
    .seg .tbtn.active{border-color:#3b82f6; background:#1a2330}
    .sp {width:140px}
    .align-right {margin-left:auto; display:flex; gap:8px}
    /* Obere Param-Leiste */
    .bar {display:grid; grid-template-columns: 1.2fr 1.2fr .7fr .8fr 1.2fr .6fr .6fr; gap:10px}
    @media (max-width:1100px){ .grid-2{grid-template-columns:1fr} .bar{grid-template-columns:1fr 1fr} }
  </style>
</head>
<body>
  <!-- Kopf wie auf den anderen Seiten -->
  <header>
    <h1 class="text-xl font-bold">LocalMediaSuite</h1>
    <nav class="flex gap-2 flex-wrap">
      <a href="index.html">Home</a>
      <a href="image.html">Image (SFW)</a>
      <a href="image_nsfw.html">Image (NSFW)</a>
      <a href="video.html">Video (SFW)</a>
      <a href="video_nsfw.html">Video (NSFW)</a>
      <a href="gallery.html">Gallery</a>
      <a href="catalog.html">Catalog</a>
      <a href="settings.html">Settings</a>
    </nav>
  </header>

  <main class="page">
    <h2 style="margin: 6px 0 14px; font-weight:700">Remover + Pose</h2>

    <!-- Obere Param-Leiste -->
    <div class="panel" style="margin-bottom:12px">
      <div class="bar">
        <div class="field">
          <label>Aktion</label>
          <select id="action">
            <option value="remove">remove clothing / object</option>
            <option value="replace">replace clothing / object</option>
            <option value="inpaint">general inpaint / fix</option>
          </select>
        </div>
        <div class="field">
          <label>Klamotten‚ÄëIdee (optional)</label>
          <input id="outfitIdea" placeholder="z.‚ÄØB. red lace lingerie / swirl dress" />
        </div>
        <div class="field">
          <label>NSFW</label>
          <select id="nsfw"><option>false</option><option>true</option></select>
        </div>
        <div class="field">
          <label>Format</label>
          <select id="fmt"><option>jpg</option><option>png</option><option>webp</option></select>
        </div>
        <div class="field">
          <label>Pose‚ÄëPrompt</label>
          <input id="posePrompt" placeholder="z.‚ÄØB. kneeling / doggy / selfie" />
        </div>
        <div class="field">
          <label>Personen</label>
          <select id="persons"><option>1</option><option>2</option><option>3</option></select>
        </div>
        <div class="field">
          <label>Guidance</label>
          <input id="guidance" type="number" step="0.1" value="7.0" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <span class="side-note">Tipp: F√ºr Video‚ÄëOut brauchst du sp√§ter den Video‚ÄëGenerator (img‚Üívideo). Hier erzeugst du das bearbeitete Bild plus Pose.</span>
      </div>
    </div>

    <!-- Hauptbereich: Quelle/Maske & Ergebnis -->
    <div class="grid-2">
      <!-- Quelle & Maske -->
      <section class="panel">
        <div class="row" style="justify-content:space-between; margin-bottom:10px">
          <div class="row" style="gap:8px">
            <label class="pill">
              <input id="file" type="file" accept="image/*" />
            </label>
            <label class="row side-note" style="gap:6px">
              <input id="showMask" type="checkbox" checked /> Maske anzeigen
            </label>
          </div>
          <button id="copyDown" class="btn ghost" title="In unteren Vergleich kopieren">‚¨áÔ∏è In Vergleich kopieren</button>
        </div>

        <div id="canvasWrap" class="board">
          <div class="placeholder">Bild w√§hlen‚Ä¶</div>
          <canvas id="imgCanvas"></canvas>
          <canvas id="maskCanvas" style="position:absolute; inset:0"></canvas>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="field sp">
            <label>Steps</label>
            <input id="steps" type="range" min="5" max="50" value="30" />
          </div>
          <div class="field sp">
            <label>Aufl√∂sung</label>
            <select id="res">
              <option>768x1024 (Portrait)</option>
              <option selected>1024x768 (Landscape)</option>
              <option>1024x1024 (Square)</option>
            </select>
          </div>
        </div>
      </section>

      <!-- Ergebnis -->
      <section class="panel">
        <div class="row" style="justify-content:space-between; margin-bottom:10px">
          <div class="chip">Bearbeitet</div>
          <button id="toCompare" class="btn ghost">‚¨áÔ∏è In unteren Vergleich kopieren</button>
        </div>
        <div id="resultWrap" class="board">
          <div class="placeholder">Noch kein Ergebnis</div>
          <img id="resultImg" style="max-width:100%; max-height:100%; object-fit:contain" />
        </div>
      </section>
    </div>

    <!-- Vergleich unten -->
    <div class="panel" style="margin-top:12px">
      <div class="row" style="margin-bottom:8px">
        <div class="chip active">Vergleich</div>
        <span class="side-note">Links Original ‚Ä¢ Rechts Bearbeitet</span>
      </div>
      <div class="grid-2">
        <div class="board"><img id="cmpSrc" style="max-width:100%; max-height:100%; object-fit:contain" /></div>
        <div class="board"><img id="cmpDst" style="max-width:100%; max-height:100%; object-fit:contain" /></div>
      </div>
    </div>

    <!-- Dock: Werkzeuge & Aktionen -->
    <div class="dock">
      <div class="tools">
        <div class="seg" role="group" aria-label="Tools">
          <button class="tbtn active" id="toolBrush" title="B (Brush)">‚úèÔ∏è Brush</button>
          <button class="tbtn" id="toolEraser" title="E (Eraser)">ü©π Eraser</button>
          <button class="tbtn" id="toolLasso" title="L (Lasso)">ü™§ Lasso</button>
        </div>

        <div class="seg">
          <label class="side-note">Pinselgr√∂√üe</label>
          <input id="brushSize" type="range" min="2" max="120" value="42" />
        </div>

        <div class="seg">
          <button class="tbtn" id="closeLasso" title="Enter">Lasso schlie√üen/f√ºllen</button>
          <button class="tbtn" id="clearMask" title="U">Maske l√∂schen</button>
          <button class="tbtn" id="undo" title="Z">‚Ü∂ Undo</button>
        </div>
      </div>

      <div class="align-right">
        <button id="genImage" class="btn primary">üñºÔ∏è Generieren (Image)</button>
        <button id="genVideo" class="btn">üé¨ Generieren (Video)</button>
      </div>
    </div>
  </main>

  <script>
    // ‚Äî‚Äî‚Äî‚Äî‚Äî Einfaches Masken‚ÄëCanvas (Brush/Eraser/Lasso) ‚Äî‚Äî‚Äî‚Äî‚Äî
    const imgCanvas = document.getElementById('imgCanvas');
    const maskCanvas = document.getElementById('maskCanvas');
    const ctxImg   = imgCanvas.getContext('2d');
    const ctxMask  = maskCanvas.getContext('2d');

    const state = {
      img: null,
      tool: 'brush', // 'brush' | 'eraser' | 'lasso'
      lasso: [],
      drawing: false,
      showMask: true,
      brushSize: 42,
      history: []
    };

    function fitCanvases() {
      const wrap = document.getElementById('canvasWrap');
      const w = wrap.clientWidth, h = Math.max(wrap.clientHeight, 520);
      imgCanvas.width = maskCanvas.width = w;
      imgCanvas.height = maskCanvas.height = h;
      redraw();
    }
    window.addEventListener('resize', fitCanvases);

    function redraw() {
      // Hintergrund
      ctxImg.clearRect(0,0,imgCanvas.width,imgCanvas.height);
      if (state.img) {
        // Bild so einpassen, dass es maximal Platz nutzt
        const {width:W, height:H} = state.img;
        const r = Math.min(imgCanvas.width/W, imgCanvas.height/H);
        const w = W*r, h = H*r;
        const x = (imgCanvas.width - w)/2, y = (imgCanvas.height - h)/2;
        ctxImg.drawImage(state.img, x, y, w, h);
        imgCanvas.parentElement.querySelector('.placeholder')?.remove();
      }
      // Maske overlay
      ctxMask.globalCompositeOperation = 'source-over';
      ctxMask.globalAlpha = state.showMask ? 0.55 : 0.0;
      // (Maskeninhalt bleibt ‚Äî hier nur Alpha gesetzt)
    }

    // Bild laden
    document.getElementById('file').addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const url = URL.createObjectURL(f);
      const img = new Image(); img.onload = ()=>{
        state.img = img; fitCanvases();
        document.getElementById('cmpSrc').src = url;
      };
      img.src = url;
    });

    // Masken‚ÄëZeichnen
    function startDraw(x,y){
      state.drawing = true;
      ctxMask.lineCap = ctxMask.lineJoin = 'round';
      ctxMask.lineWidth = state.brushSize;
      ctxMask.strokeStyle = 'rgba(233,30,99,1)';
      ctxMask.globalCompositeOperation = (state.tool === 'eraser') ? 'destination-out' : 'source-over';
      ctxMask.beginPath();
      ctxMask.moveTo(x,y);
      pushHistory();
    }
    function moveDraw(x,y){
      if(!state.drawing) return;
      if(state.tool === 'lasso'){
        state.lasso.push([x,y]);
        drawLassoPreview();
      } else {
        ctxMask.lineTo(x,y); ctxMask.stroke();
      }
    }
    function endDraw(){
      if(!state.drawing) return;
      state.drawing = false;
      if(state.tool === 'lasso' && state.lasso.length > 2){
        fillLasso();
      }
    }

    function canvasPos(ev){
      const r = maskCanvas.getBoundingClientRect();
      const x = (ev.touches?ev.touches[0].clientX:ev.clientX) - r.left;
      const y = (ev.touches?ev.touches[0].clientY:ev.clientY) - r.top;
      return {x,y};
    }

    maskCanvas.addEventListener('mousedown', e=>{ const p=canvasPos(e); startDraw(p.x,p.y) });
    maskCanvas.addEventListener('mousemove', e=>{ const p=canvasPos(e); moveDraw(p.x,p.y) });
    maskCanvas.addEventListener('mouseup',   endDraw);
    maskCanvas.addEventListener('mouseleave',endDraw);
    maskCanvas.addEventListener('touchstart', e=>{ const p=canvasPos(e); startDraw(p.x,p.y) }, {passive:true});
    maskCanvas.addEventListener('touchmove',  e=>{ const p=canvasPos(e); moveDraw(p.x,p.y) }, {passive:true});
    maskCanvas.addEventListener('touchend',   endDraw);

    function drawLassoPreview(){
      ctxMask.save();
      ctxMask.globalAlpha = 1;
      ctxMask.globalCompositeOperation = 'source-over';
      ctxMask.strokeStyle = 'rgba(233,30,99,0.7)';
      ctxMask.lineWidth = 2;
      ctxMask.beginPath();
      const pts = state.lasso;
      if(!pts.length) return;
      ctxMask.moveTo(pts[0][0], pts[0][1]);
      for(let i=1;i<pts.length;i++) ctxMask.lineTo(pts[i][0], pts[i][1]);
      ctxMask.stroke();
      ctxMask.restore();
    }

    function fillLasso(){
      // F√ºlle das Polygon in die Maske
      const tmp = document.createElement('canvas');
      tmp.width = maskCanvas.width; tmp.height = maskCanvas.height;
      const tctx = tmp.getContext('2d');
      tctx.fillStyle = 'rgba(233,30,99,1)';
      tctx.beginPath();
      const pts = state.lasso;
      tctx.moveTo(pts[0][0], pts[0][1]);
      for(let i=1;i<pts.length;i++) tctx.lineTo(pts[i][0], pts[i][1]);
      tctx.closePath(); tctx.fill();
      ctxMask.globalCompositeOperation = 'source-over';
      ctxMask.drawImage(tmp,0,0);
      state.lasso = [];
    }

    // UI‚ÄëControls
    document.getElementById('showMask').addEventListener('change', e=>{ state.showMask = e.target.checked; redraw(); });
    document.getElementById('brushSize').addEventListener('input', e=> state.brushSize = +e.target.value);

    // Tool‚ÄëToggles
    function setTool(t){
      state.tool = t;
      ['toolBrush','toolEraser','toolLasso'].forEach(id=>document.getElementById(id).classList.remove('active'));
      if(t==='brush') document.getElementById('toolBrush').classList.add('active');
      if(t==='eraser')document.getElementById('toolEraser').classList.add('active');
      if(t==='lasso') document.getElementById('toolLasso').classList.add('active');
    }
    document.getElementById('toolBrush').onclick = ()=>setTool('brush');
    document.getElementById('toolEraser').onclick= ()=>setTool('eraser');
    document.getElementById('toolLasso').onclick = ()=>setTool('lasso');

    // Lasso schlie√üen / Maske l√∂schen / Undo
    document.getElementById('closeLasso').onclick = fillLasso;
    document.getElementById('clearMask').onclick = ()=>{ pushHistory(); ctxMask.clearRect(0,0,maskCanvas.width,maskCanvas.height); };
    document.getElementById('undo').onclick = undo;

    // Shortcuts
    document.addEventListener('keydown', (e)=>{
      if(e.key.toLowerCase()==='b') setTool('brush');
      if(e.key.toLowerCase()==='e') setTool('eraser');
      if(e.key.toLowerCase()==='l') setTool('lasso');
      if(e.key==='Enter') fillLasso();
      if(e.key.toLowerCase()==='u') { pushHistory(); ctxMask.clearRect(0,0,maskCanvas.width,maskCanvas.height); }
      if(e.key.toLowerCase()==='z') undo();
    });

    function pushHistory(){
      try{
        const snap = ctxMask.getImageData(0,0,maskCanvas.width,maskCanvas.height);
        state.history.push(snap);
        if(state.history.length>20) state.history.shift();
      }catch(e){}
    }
    function undo(){
      const snap = state.history.pop();
      if(!snap) return;
      ctxMask.clearRect(0,0,maskCanvas.width,maskCanvas.height);
      ctxMask.putImageData(snap,0,0);
    }

    // Vergleich kopieren
    document.getElementById('copyDown').onclick = ()=>{
      if(!state.img) return;
      document.getElementById('cmpSrc').src = imgCanvas.toDataURL('image/png');
    };
    document.getElementById('toCompare').onclick = ()=>{
      const el = document.getElementById('resultImg');
      if(el?.src) document.getElementById('cmpDst').src = el.src;
    };

    // Platzhalter‚ÄëGenerieren: hier nur Payload bauen ‚Äì POST an deine Universal‚ÄëRoute
    async function submit(kind){
      if(!state.img){ alert('Bitte zuerst ein Bild laden.'); return; }
      const fd = new FormData();
      // Bild
      // Hole das Original als Blob erneut (oder nimm dataURL -> fetch -> blob)
      const srcDataUrl = imgCanvas.toDataURL('image/png');
      const srcBlob = await (await fetch(srcDataUrl)).blob();
      fd.append('image', srcBlob, 'source.png');

      // Maske
      const maskDataUrl = maskCanvas.toDataURL('image/png');
      const maskBlob = await (await fetch(maskDataUrl)).blob();
      fd.append('mask', maskBlob, 'mask.png');

      // Parameter
      fd.append('mode', 'inpaint_pose');
      fd.append('action', document.getElementById('action').value);
      fd.append('outfit_idea', document.getElementById('outfitIdea').value);
      fd.append('pose_prompt', document.getElementById('posePrompt').value);
      fd.append('persons', document.getElementById('persons').value);
      fd.append('guidance', document.getElementById('guidance').value);
      fd.append('steps', document.getElementById('steps').value);
      fd.append('resolution', document.getElementById('res').value);
      fd.append('format', document.getElementById('fmt').value);
      fd.append('nsfw', document.getElementById('nsfw').value);

      // Ziel
      fd.append('target', kind); // 'image' | 'video' (Server kann img2video anschlie√üen)

      // Sende an deine Universal‚ÄëAPI
      try{
        const r = await fetch('/api/generate/universal', { method:'POST', body:fd });
        const j = await r.json();
        if(!j.ok){ alert('Fehler: ' + (j.message || j.error || 'unknown')); return; }

        if(kind==='image'){
          document.getElementById('resultImg').src = j.file || j.url || '';
          // Auto in Vergleich √ºbernehmen
          document.getElementById('cmpDst').src = j.file || j.url || '';
        }else{
          // F√ºr Video: Weiterleitung oder Hinweis
          alert('Video‚ÄëJob gestartet: ' + (j.op_id || 'OK'));
        }
      }catch(e){
        alert('Request fehlgeschlagen: ' + e.message);
      }
    }

    document.getElementById('genImage').onclick = ()=> submit('image');
    document.getElementById('genVideo').onclick = ()=> submit('video');

    // Start
    fitCanvases();
  </script>
</body>
</html>
