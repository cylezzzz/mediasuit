<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Stitch Studio – Galerie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg:#0a0e13; --panel:#0f1420; --border:#1f2a3b; --text:#e6eaf1; --muted:#9aa4b2;
      --accent:#3b82f6; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --r:12px; --gap:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}

    /* Header */
    header{position:sticky;top:0;z-index:10;background:#0a0e13d9;border-bottom:1px solid var(--border);backdrop-filter:blur(8px)}
    .header-container{max-width:1400px;margin:0 auto;padding:12px 18px;display:flex;gap:14px;align-items:center}
    .brand{display:flex;align-items:center;gap:8px;color:#e6eaf1;text-decoration:none;font-weight:800}
    .logo-dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px var(--accent)}
    .main-nav{margin-left:auto;display:flex;gap:10px;flex-wrap:wrap}
    .main-nav a{padding:6px 10px;border:1px solid transparent;border-radius:8px;color:#c8d1de;text-decoration:none}
    .main-nav a:hover,.main-nav a.active{border-color:#2a3b52;background:#0f172a}

    /* Layout */
    .wrap{max-width:1400px;margin:18px auto;padding:0 18px;display:grid;gap:var(--gap)}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);overflow:hidden}
    .card-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border);font-weight:700}
    .card-body{padding:14px}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .field{display:flex;align-items:center;gap:8px;background:#0c1728;border:1px solid var(--border);padding:6px 10px;border-radius:9px}
    select,input{background:transparent;border:0;color:var(--text);outline:none}
    .btn{background:#1e2937;border:1px solid #2a3b52;color:#e6eaf1;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.08)}
    .btn.danger{background:var(--danger);border-color:var(--danger)}
    .btn.ghost{background:transparent;border:1px solid var(--border)}
    .status{font-size:12px;color:var(--muted)}

    /* Grid */
    .item-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
    @media (max-width:1200px){.item-grid{grid-template-columns:repeat(4,1fr)}}
    @media (max-width:860px){.item-grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:620px){.item-grid{grid-template-columns:repeat(2,1fr)}}

    .item-card{position:relative;border:1px solid var(--border);background:#0f1626;border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
    .item-thumb{aspect-ratio:1/1;background:#0b1323 center/cover no-repeat}
    .item-info{display:flex;align-items:center;justify-content:space-between;gap:6px;padding:8px 10px;border-top:1px solid var(--border)}
    .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:13px;color:#d8dfeb}
    .actions{display:flex;gap:6px}
    .iconbtn{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:8px;border:1px solid #2a3b52;background:#121b2b;cursor:pointer}
    .iconbtn:hover{filter:brightness(1.1)}

    /* Modal */
    .modal{position:fixed;inset:0;background:#000c;display:none;align-items:center;justify-content:center;padding:20px}
    .modal.open{display:flex}
    .modal-box{width:min(96vw,1200px);background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
    .modal-head{display:flex;align-items:center;gap:10px;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border)}
    .modal-title{font-weight:700}
    .modal-body{padding:10px;display:flex;align-items:center;justify-content:center;background:#0b1323}
    .modal-body img{max-width:100%;height:auto;border-radius:8px}
    .modal-body video{max-width:100%;border-radius:8px;background:#000}
    .modal-foot{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-top:1px solid var(--border)}
    .meta{font-size:12px;color:var(--muted)}
    .close{background:#1f2937;border:1px solid #2a3b52;color:#e6eaf1;padding:6px 10px;border-radius:8px;cursor:pointer}
    .danger{background:var(--danger);border-color:var(--danger)}
    .download{background:var(--ok);border-color:var(--ok);color:#03160f}

    /* Empty */
    .empty{padding:30px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="header-container">
      <a href="index.html" class="brand"><span class="logo-dot"></span><span>Stitch Studio</span></a>
      <nav class="main-nav">
        <a href="create.html">Erstellen</a>
        <a class="active" href="gallery.html">Galerie</a>
        <a href="catalog.html">Katalog</a>
        <a href="character_lab.html">Charaktere</a>
        <a href="flirt.html">Flirt KI</a>
      </nav>
    </div>
  </header>

  <main>
    <div class="wrap">
      <!-- Toolbar -->
      <div class="card">
        <div class="card-header">
          <div>Deine Galerie</div>
          <div class="status" id="galStatus">Lade…</div>
        </div>
        <div class="card-body">
          <div class="toolbar">
            <div class="field">🔎
              <input id="search" type="text" placeholder="Suche nach Name…" />
            </div>
            <div class="field">🧭
              <select id="sort">
                <option value="new">Neueste zuerst</option>
                <option value="old">Älteste zuerst</option>
                <option value="name">Name (A–Z)</option>
              </select>
            </div>
            <div class="field">🧰
              <select id="filter">
                <option value="all">Alle</option>
                <option value="image">Nur Bilder</option>
                <option value="video">Nur Videos</option>
              </select>
            </div>
            <button class="btn ghost" id="refresh">Aktualisieren</button>
          </div>
        </div>
      </div>

      <!-- Grid -->
      <div class="card">
        <div class="card-body">
          <div class="item-grid" id="grid"></div>
          <div id="empty" class="empty" style="display:none">Keine Dateien gefunden.</div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-box">
      <div class="modal-head">
        <div class="modal-title" id="mTitle">Vorschau</div>
        <div style="display:flex;gap:8px">
          <a id="mDownload" class="btn download" href="#" download>Download</a>
          <button id="mDelete" class="btn danger">Löschen</button>
          <button id="mClose" class="close">Schließen</button>
        </div>
      </div>
      <div class="modal-body" id="mBody"><div class="empty">Lade…</div></div>
      <div class="modal-foot"><div class="meta" id="mMeta"></div><div class="status" id="mStatus"></div></div>
    </div>
  </div>

  <script>
    // ---- Config / Endpoints ----
    const API_LIST = "/api/outputs";             // bevorzugt
    const API_DELETE_QS = "/api/outputs";        // DELETE /api/outputs?name=...
    const API_DELETE_POST = "/api/delete";       // POST { name }
    const FALLBACK_INDEX = "/outputs/index.json";// optionales statisches Listing

    // ---- State ----
    let allItems = [];   // {name,url,type,size,mtime}
    let viewItems = [];  // gefiltert/sortiert

    // ---- Utils ----
    const $ = sel => document.querySelector(sel);
    const grid = $('#grid'), empty = $('#empty'), galStatus = $('#galStatus');

    const fmtSize = (n)=>{
      if (!n && n !== 0) return '–';
      const u = ['B','KB','MB','GB','TB']; let i=0, v=n;
      while(v>=1024 && i<u.length-1){ v/=1024; i++; }
      return v.toFixed(v<10?1:0)+' '+u[i];
    };
    const fmtDate = (s)=> s ? new Date(s).toLocaleString() : '–';

    const isVideo = (name)=> /\.(mp4|webm|mov|m4v|avi|mkv)$/i.test(name);
    const isImage = (name)=> /\.(png|jpe?g|gif|webp|bmp|tiff)$/i.test(name);

    // ---- Loading ----
    async function fetchList(){
      galStatus.textContent = 'Lade…';
      // 1) bevorzugter API‑Weg
      try{
        const r = await fetch(API_LIST, {method:'GET'});
        if (r.ok){
          const data = await r.json();
          if (Array.isArray(data)){
            galStatus.textContent = 'OK';
            return data;
          }
        }
        throw new Error('API antwortet nicht wie erwartet');
      }catch(_){
        // 2) Fallback: statischer Index
        try{
          const r2 = await fetch(FALLBACK_INDEX, {method:'GET'});
          if (r2.ok){
            galStatus.textContent = 'Fallback';
            return await r2.json();
          }
          throw new Error('Fallback nicht verfügbar');
        }catch(e2){
          galStatus.textContent = 'Fehler';
          console.warn('Galerie laden fehlgeschlagen:', e2);
          return [];
        }
      }
    }

    function applyView(){
      const q = $('#search').value.trim().toLowerCase();
      const f = $('#filter').value;
      const s = $('#sort').value;

      viewItems = allItems.filter(it=>{
        if (f==='image' && it.type!=='image') return false;
        if (f==='video' && it.type!=='video') return false;
        if (q && !it.name.toLowerCase().includes(q)) return false;
        return true;
      });

      viewItems.sort((a,b)=>{
        if (s==='name') return a.name.localeCompare(b.name);
        if (s==='old') return (new Date(a.mtime) - new Date(b.mtime));
        // default: new
        return (new Date(b.mtime) - new Date(a.mtime));
      });

      renderGrid();
    }

    function renderGrid(){
      grid.innerHTML = '';
      if (!viewItems.length){ empty.style.display='block'; return; }
      empty.style.display='none';

      for(const it of viewItems){
        const card = document.createElement('div');
        card.className = 'item-card';

        const thumb = document.createElement('div');
        thumb.className = 'item-thumb';

        // Für Videos ein kleines Icon Overlay
        if (it.type==='video'){
          thumb.style.backgroundImage = `linear-gradient(0deg, rgba(0,0,0,.35), rgba(0,0,0,.35)), url('${it.poster || it.url}#t=0.1')`;
        } else {
          thumb.style.backgroundImage = `url('${it.url}')`;
        }

        thumb.addEventListener('click', ()=> openModal(it));

        const info = document.createElement('div');
        info.className = 'item-info';
        const name = document.createElement('div');
        name.className = 'name';
        name.title = it.name;
        name.textContent = it.name;
        const actions = document.createElement('div'); actions.className='actions';

        const btnOpen = document.createElement('button');
        btnOpen.className='iconbtn'; btnOpen.title='Vorschau';
        btnOpen.innerHTML='🔍'; btnOpen.onclick=()=> openModal(it);

        const aDown = document.createElement('a');
        aDown.className='iconbtn'; aDown.title='Download'; aDown.href=it.url; aDown.download='';
        aDown.textContent='⬇️';

        const btnDel = document.createElement('button');
        btnDel.className='iconbtn'; btnDel.title='Löschen'; btnDel.textContent='🗑️';
        btnDel.onclick=()=> deleteItem(it);

        actions.append(btnOpen, aDown, btnDel);
        info.append(name, actions);

        card.append(thumb, info);
        grid.append(card);
      }
    }

    // ---- Modal ----
    const modal = $('#modal'), mBody = $('#mBody'), mTitle = $('#mTitle'), mMeta = $('#mMeta'),
          mDownload = $('#mDownload'), mDelete = $('#mDelete'), mClose = $('#mClose');
    let currentItem = null;

    function openModal(it){
      currentItem = it;
      mTitle.textContent = it.name;
      mMeta.textContent = `${it.type.toUpperCase()} • ${fmtSize(it.size)} • ${fmtDate(it.mtime)}`;
      mDownload.href = it.url;
      mDownload.setAttribute('download','');

      mBody.innerHTML = '';
      if (it.type==='image'){
        const img = document.createElement('img'); img.src = it.url; img.alt = it.name;
        mBody.append(img);
      } else {
        const vid = document.createElement('video'); vid.src = it.url; vid.controls = true; vid.autoplay=false;
        vid.playsInline = true; vid.preload = 'metadata';
        mBody.append(vid);
      }
      modal.classList.add('open');
    }
    function closeModal(){ modal.classList.remove('open'); currentItem = null; }
    mClose.addEventListener('click', closeModal);
    modal.addEventListener('click', (e)=>{ if (e.target===modal) closeModal(); });

    // ---- Delete ----
    async function deleteItem(it){
      if (!confirm(`"${it.name}" wirklich löschen?`)) return;

      // 1) DELETE /api/outputs?name=...
      try{
        const r = await fetch(`${API_DELETE_QS}?name=${encodeURIComponent(it.name)}`, { method:'DELETE' });
        if (r.ok){
          afterDelete(it);
          return;
        }
      }catch(_){}

      // 2) POST /api/delete {name}
      try{
        const r2 = await fetch(API_DELETE_POST, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ name: it.name })
        });
        if (r2.ok){
          afterDelete(it);
          return;
        }
      }catch(_){}

      alert('Konnte nicht löschen – Backend‑Endpoint nicht verfügbar.');
    }

    function afterDelete(it){
      // aus Listen entfernen
      allItems = allItems.filter(x=>x.name!==it.name);
      applyView();
      if (currentItem && currentItem.name===it.name) closeModal();
    }

    mDelete.addEventListener('click', ()=> currentItem && deleteItem(currentItem));

    // ---- Wiring ----
    $('#search').addEventListener('input', applyView);
    $('#filter').addEventListener('change', applyView);
    $('#sort').addEventListener('change', applyView);
    $('#refresh').addEventListener('click', init);

    async function init(){
      const raw = await fetchList();
      // Normalisieren & Typ erkennen
      allItems = raw.map(x=>{
        const name = x.name || (x.url ? x.url.split('/').pop() : 'unbenannt');
        const type = x.type || (isVideo(name) ? 'video' : isImage(name) ? 'image' : 'other');
        return {
          name,
          url: x.url || `/outputs/${name}`,
          type,
          size: x.size ?? null,
          mtime: x.mtime ?? null,
          poster: x.poster
        };
      }).filter(x=> x.type==='image' || x.type==='video');

      applyView();

      galStatus.textContent = allItems.length
        ? `Bereit • ${allItems.length} Dateien`
        : 'Keine Dateien';
    }

    // Start
    init();
  </script>
</body>
</html>
