<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>LocalMediaSuite – Video (NSFW)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Shared styling and logic -->
  <link rel="stylesheet" href="assets/styles.css">
  <script defer src="assets/app.js"></script>
</head>
<body>
  <header>
    <h1 class="text-xl font-bold">LocalMediaSuite</h1>
    <nav class="flex gap-2 flex-wrap">
      <a href="index.html">Home</a>
      <a href="image.html">Image (SFW)</a>
      <a href="image_nsfw.html">Image (NSFW)</a>
      <a href="video.html">Video (SFW)</a>
      <a href="video_nsfw.html" class="active">Video (NSFW)</a>
      <a href="gallery.html">Gallery</a>
      <a href="catalog.html">Catalog</a>
      <a href="settings.html">Settings</a>
    </nav>
  </header>
  <main style="padding:2rem;max-width:1100px;margin:0 auto;">
    <form id="video-form" action="/api/generate/universal" method="POST" enctype="multipart/form-data" data-endpoint="/api/generate/universal">
      <input type="hidden" name="type" value="video">
      <input type="hidden" id="mode_input" name="mode" value="text2video">
      <h2 class="text-xl font-bold mb-4">Videogenerator (NSFW)</h2>
      <div class="generator-layout">
        <!-- Sidebar with mode, models and settings -->
        <div class="sidebar flex flex-col gap-4" style="flex:0 0 320px;">
          <!-- Mode and model selection -->
          <div class="card">
            <div class="mb-4">
              <label class="label" for="mode">Modus</label>
              <select id="mode" class="input" name="mode_select">
                <option value="text2video" selected>Text → Video</option>
                <option value="img2video">Bild → Video</option>
              </select>
              <p class="text-sm text-muted mt-1">Pro Lauf wählbar. Der Model‑Picker passt sich automatisch an.</p>
            </div>
            <div id="model-tabs"></div>
          </div>
          <!-- Settings -->
          <div class="card">
            <h3 class="text-md font-semibold mb-3">Einstellungen</h3>
            <div class="mb-3">
              <label class="label" for="vid_resolution">Auflösung</label>
              <select id="vid_resolution" class="input">
                <option value="1280x720" selected>1280×720</option>
                <option value="1920x1080">1920×1080</option>
                <option value="1024x576">1024×576</option>
              </select>
              <input type="hidden" id="width_input" name="width" value="1280">
              <input type="hidden" id="height_input" name="height" value="720">
            </div>
            <div class="mb-3">
              <label class="label" for="fps">FPS</label>
              <input id="fps" class="input" type="number" name="fps" min="1" max="60" value="24">
            </div>
            <div class="mb-3">
              <label class="label" for="vid_length">Länge (Sek.)</label>
              <input id="vid_length" class="input" type="number" min="1" max="60" value="3">
            </div>
            <div>
              <label class="label" for="num_frames">Frames (optional)</label>
              <input id="num_frames" class="input" type="number" name="num_frames" min="0" max="240" value="0">
            </div>
          </div>
          <!-- Kategorien & Zufall -->
          <div class="card">
            <h3 class="text-md font-semibold mb-3">Ideen & Kategorien</h3>
            <div class="flex gap-2 mb-2">
              <button type="button" id="btn-random" class="btn secondary w-full">Zufalls‑Prompt</button>
            </div>
            <div id="cat-chips" class="flex flex-wrap gap-2"></div>
          </div>
        </div>
        <!-- Main area with preview and prompt -->
        <div class="main-area flex flex-col gap-4" style="flex:1;">
          <!-- Large preview/output area -->
          <div id="display-container" class="card hidden" style="min-height:360px; display:flex; align-items:center; justify-content:center;"></div>
          <div class="card flex-1 flex flex-col gap-4">
            <div>
              <label class="label" for="prompt">Prompt</label>
              <textarea id="prompt" name="prompt" class="input" rows="4" placeholder="Beschreibe den Clip… (Startframe wird ggf. automatisch erzeugt)" required></textarea>
              <div id="prompt-suggestions" class="flex flex-wrap gap-2 mt-2"></div>
            </div>
            <!-- Upload & Remix -->
            <div id="init-block">
              <div class="mb-4">
                <label class="label" for="init_image">Upload (Startbild)</label>
                <input id="init_image" class="input" type="file" name="init_image" accept="image/*">
                <p class="text-sm text-muted mt-1">Für Bild→Video ist Upload oder Remix erforderlich. Bei Text→Video wird die Startframe automatisch generiert.</p>
                <div id="preview-container" class="mt-2 hidden">
                  <img id="preview-img" src="" alt="Vorschau" style="max-width:100%; border-radius:0.5rem;">
                </div>
              </div>
              <div>
                <label class="label" for="remix">Remix (aus Galerie)</label>
                <select id="remix" class="input">
                  <option value="">— wählen —</option>
                </select>
                <input type="hidden" id="init_url" name="init_url">
              </div>
            </div>
            <!-- Buttons -->
            <div class="flex gap-3">
              <button type="submit" class="btn primary">Generieren</button>
              <button type="button" id="btn-clear" class="btn secondary">Prompt leeren</button>
            </div>
          </div>
        </div>
      </div>
    </form>
  </main>
  <script>
  // Preview logic for start frame upload
  document.addEventListener('DOMContentLoaded', function(){
    const fileInput = document.getElementById('init_image');
    const previewContainer = document.getElementById('preview-container');
    const previewImg = document.getElementById('preview-img');
    fileInput.addEventListener('change', function(){
      const file = this.files && this.files[0];
      const display = document.getElementById('display-container');
      if(file){
        const reader = new FileReader();
        reader.onload = function(e){
          previewImg.src = e.target.result;
          previewContainer.classList.remove('hidden');
          // show large preview
          if(display){
            display.innerHTML = '';
            const imgEl = document.createElement('img');
            imgEl.src = e.target.result;
            imgEl.style.maxWidth = '100%';
            imgEl.style.borderRadius = '0.5rem';
            display.appendChild(imgEl);
            display.classList.remove('hidden');
          }
        };
        reader.readAsDataURL(file);
      } else {
        previewContainer.classList.add('hidden');
        previewImg.src = '';
        if(display){
          display.classList.add('hidden');
          display.innerHTML = '';
        }
      }
    });
    // Update width/height on resolution change
    const resSelect = document.getElementById('vid_resolution');
    const widthField = document.getElementById('width_input');
    const heightField = document.getElementById('height_input');
    function updateRes(){
      const parts = (resSelect.value||'').split('x');
      if(parts.length === 2){ widthField.value = parseInt(parts[0]); heightField.value = parseInt(parts[1]); }
    }
    if(resSelect){ resSelect.addEventListener('change', updateRes); updateRes(); }
    // Frames calculation
    const fpsInput = document.getElementById('fps');
    const lenInput = document.getElementById('vid_length');
    const framesInput = document.getElementById('num_frames');
    function updateFrames(){
      const f = parseInt(fpsInput.value||'0');
      const s = parseInt(lenInput.value||'0');
      if(!framesInput.hasAttribute('data-manual')){
        if(f>0 && s>0){ framesInput.value = f*s; }
      }
    }
    if(fpsInput && lenInput && framesInput){
      fpsInput.addEventListener('change', updateFrames);
      lenInput.addEventListener('change', updateFrames);
      framesInput.addEventListener('input', ()=>{ framesInput.setAttribute('data-manual','true'); });
      updateFrames();
    }
  });
  </script>
  <script>
  /*
    Main initialization for NSFW video page.
    Loads models and suggestions based on mode and NSFW flag,
    populates remix dropdown, attaches model selection to form,
    and handles generation events.
  */
  async function fetchSuggestions(domain, nsfw, purpose){
    const urls = [
      `/api/suggestions?domain=${domain}&nsfw=${nsfw}&purpose=${purpose}`,
      `/api/suggestions?type=${domain}&nsfw=${nsfw}&purpose=${purpose}`,
      `/api/suggestions?type=${domain}&nsfw=${nsfw}`
    ];
    for(const u of urls){ try{ const r=await fetch(u); if(r.ok) return await r.json(); }catch{} }
    // Fallback suggestions for NSFW video
    if(purpose === 'img2video'){
      return {
        categories:[
          { id:'motion', label:'Bewegung', ideas:[
            'dramatische Körperbewegung, langsame Kamerafahrt, sinnliche Unschärfe',
            'nahe Gestik, verweilende Kamera, cineastische Farbgebung'
          ]},
          { id:'atmosphere', label:'Atmosphäre', ideas:[
            'dunkler Raum mit Kerzenlicht, weiche Highlights, intime Stimmung',
            'gedämpftes neonfarbenes Licht, regenüberzogene Straßen, Retro‑Futurismus'
          ]}
        ],
        modifiers:['weicher Filmgrain, warme Töne','hoher Dynamikumfang, tiefes Kontrastverhältnis']
      };
    } else {
      return {
        categories:[
          { id:'mood', label:'Stimmung', ideas:[
            'verführerisches Lounge‑Ambiente bei Nacht, langsame Kamerafahrt, dezente Details',
            'Studio‑Szene mit dramatischer Beleuchtung, weiche Fokussierung'
          ]},
          { id:'fantasy', label:'Fantasy', ideas:[
            'surrealer Traum, schwerelos durch Wolken, ätherisches Licht',
            'neon‑Cyberpunk‑Stadt bei Nacht, regenreflektierte Straßen, futuristische Atmosphäre'
          ]}
        ],
        modifiers:['sanfter Filmgrain, warme Highlights','tiefer Kontrast, großer Dynamikumfang']
      };
    }
  }
  async function fetchGalleryImages(){
    const urls=['/api/files?type=image','/api/gallery?type=image','/api/files/images'];
    for(const u of urls){ try{ const r=await fetch(u); if(r.ok) return await r.json(); }catch{} }
    return [];
  }
  function pushPrompt(textarea, addition){
    const cur=textarea.value.trim();
    if(!cur){ textarea.value=addition; return; }
    if(!cur.toLowerCase().includes(addition.toLowerCase())){
      textarea.value = cur + ', ' + addition;
    }
  }
  (async function(){
    const NSFW = true;
    let PURPOSE = 'text2video';
    const PAGE_KEY = () => `video:${PURPOSE}:${NSFW?'nsfw':'sfw'}`;
    async function loadAndRenderModels(){
      const models = await LMS.loadModels('video', NSFW, PURPOSE);
      const sel = LMS.getSelectedModel(PAGE_KEY());
      if(!sel && models.length) LMS.setSelectedModel(PAGE_KEY(), models[0].id);
      LMS.renderModelTabs({
        container: document.getElementById('model-tabs'),
        models,
        onSelect:(id)=>LMS.setSelectedModel(PAGE_KEY(), id),
        activeId: LMS.getSelectedModel(PAGE_KEY()),
        title: NSFW ? 'Kompatible Video‑Modelle (NSFW‑geeignet)' : 'Kompatible Video‑Modelle (SVD)'
      });
    }
    async function loadAndRenderSuggestions(){
      const sug=await fetchSuggestions('video', NSFW, PURPOSE);
      const catWrap=document.getElementById('cat-chips');
      const ideasWrap=document.getElementById('prompt-suggestions');
      const txt=document.getElementById('prompt');
      catWrap.innerHTML=''; ideasWrap.innerHTML='';
      (sug.categories||[]).forEach(c=>{
        const b=document.createElement('button');
        b.type='button'; b.className='chip'; b.textContent=c.label;
        b.addEventListener('click', ()=>{
          ideasWrap.innerHTML='';
          (c.ideas||[]).forEach(p=>{
            const a=document.createElement('button');
            a.type='button'; a.className='btn ghost'; a.textContent=p;
            a.addEventListener('click', ()=> pushPrompt(txt,p));
            ideasWrap.appendChild(a);
          });
        });
        catWrap.appendChild(b);
      });
      document.getElementById('btn-random').onclick = ()=>{
        const cats=sug.categories||[]; if(!cats.length) return;
        const c=cats[Math.floor(Math.random()*cats.length)];
        const idea=(c.ideas||[])[Math.floor(Math.random()*((c.ideas||[]).length))]||'';
        const mod=(sug.modifiers||[])[Math.floor(Math.random()*((sug.modifiers||[]).length))]||'';
        const rp=[idea, mod].filter(Boolean).join(', ');
        if(rp) document.getElementById('prompt').value=rp;
      };
      const firstCatBtn=catWrap.querySelector('button');
      if(firstCatBtn){ firstCatBtn.click(); }
    }
    async function applyMode(){
      PURPOSE = modeSel.value;
      modeHidden.value = PURPOSE;
      initBlock.classList.toggle('hidden', PURPOSE !== 'img2video');
      await loadAndRenderModels();
      await loadAndRenderSuggestions();
    }
    const modeSel=document.getElementById('mode');
    const modeHidden=document.getElementById('mode_input');
    const initBlock=document.getElementById('init-block');
    modeSel.addEventListener('change', applyMode);
    await applyMode();
    // Populate remix select
    (async()=>{
      const remixSel=document.getElementById('remix');
      const initUrl=document.getElementById('init_url');
      if(remixSel){
        try{
          const files=await fetchGalleryImages();
          (files.items||[]).forEach(f=>{
            const opt=document.createElement('option');
            opt.value=f.url||f.file||f.path||'';
            opt.textContent=f.name||opt.value.split('/').pop();
            remixSel.appendChild(opt);
          });
          remixSel.addEventListener('change', ()=>{ initUrl.value=remixSel.value||''; });
        }catch(e){ console.warn('remix list failed', e); }
      }
    })();
    // Attach model selection to form
    LMS.attachModelToForm(document.getElementById('video-form'), PAGE_KEY());
    document.getElementById('btn-clear').addEventListener('click', ()=>{ document.getElementById('prompt').value=''; });
    window.LMS.onGenerated=(url)=>{
      // Display generated video in the large preview container
      const display = document.getElementById('display-container');
      if(display){
        display.innerHTML = '';
        const vidEl = document.createElement('video');
        vidEl.src = url;
        vidEl.controls = true;
        vidEl.style.width = '100%';
        vidEl.style.borderRadius = '0.5rem';
        display.appendChild(vidEl);
        display.classList.remove('hidden');
      }
      // hide deprecated last-output if present (legacy)
      const deprecatedBox = document.getElementById('last-output');
      if(deprecatedBox) deprecatedBox.classList.add('hidden');
      LMS.toast('Dein Video wurde generiert und ist in der Galerie verfügbar.', 'success');
    };
  })();
  </script>
</body>
</html>