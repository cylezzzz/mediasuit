<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Image</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <style>
    :root { --ink:#0d141c }
    body { font-family: 'Inter', sans-serif; }
    .chip { display:inline-flex; align-items:center; gap:.5rem; padding:.35rem .7rem; border-radius:9999px; border:1px solid #e5e7eb; background:#fff; font-size:.85rem; cursor:pointer; }
    .chip.active { background:#0f172a; color:#fff; border-color:#0f172a; }
    .btn { padding:.5rem 1rem; border-radius:.75rem; border:1px solid #e5e7eb; }
    .btn-primary { background:#000; color:#fff; border-color:#000; }
    .thumb { width:72px; height:72px; object-fit:cover; border-radius: .5rem; border:1px solid #e5e7eb; }
    canvas { max-width:100%; display:block; background:#e5e7eb; border-radius:.75rem; }
  </style>
</head>
<body class="min-h-screen bg-slate-100 text-[var(--ink)]">
  <!-- Einheitlicher Header -->
  <div id="global-header"></div>
  <script src="assets/js/nav.js"></script>

  <main class="p-6">
    <h2 class="text-2xl font-semibold mb-4">Image</h2>

    <div class="grid grid-cols-1 xl:grid-cols-[320px,1fr] gap-6">
      <!-- LEFT: Controls -->
      <aside class="bg-white rounded-xl shadow border p-4 space-y-5">
        <!-- Prompt -->
        <div class="space-y-2">
          <h3 class="text-lg font-semibold">Prompt</h3>
          <textarea id="promptInput" rows="5" class="w-full" placeholder="Was soll generiert werden?" data-persist="img.prompt"></textarea>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-sm font-medium">Kategorie</label>
              <select id="categorySelect" class="w-full" data-persist="img.category">
                <option value="">Allgemein</option>
                <option value="portrait">Portrait</option>
                <option value="landscape">Landscape</option>
                <option value="product">Product</option>
              </select>
            </div>
            <div>
              <label class="text-sm font-medium">Seitenverhältnis</label>
              <select id="aspect" class="w-full" data-persist="img.aspect">
                <option value="1:1">1:1</option>
                <option value="16:9" selected>16:9</option>
                <option value="4:5">4:5</option>
                <option value="9:16">9:16</option>
              </select>
            </div>
          </div>

          <label class="text-sm font-medium mt-2 block">Negative Prompt</label>
          <input id="neg" class="w-full" placeholder="artefacts, lowres, bad hands…" data-persist="img.neg" />

          <div class="flex gap-2 pt-2">
            <button id="btnGenerate" class="btn btn-primary">Generieren (Strg+Enter)</button>
            <button id="btnStop" class="btn">Stop</button>
          </div>
          <p id="status" class="text-sm text-slate-600"></p>
        </div>

        <!-- Presets -->
        <div class="space-y-2">
          <h3 class="text-lg font-semibold">Filter (vordefiniert)</h3>
          <div id="filters" class="flex flex-wrap gap-2">
            <span class="chip" data-f="none">None</span>
            <span class="chip" data-f="vintage">Vintage</span>
            <span class="chip" data-f="sepia">Sepia</span>
            <span class="chip" data-f="noir">Noir</span>
            <span class="chip" data-f="vibrant">Vibrant</span>
            <span class="chip" data-f="warm">Warm</span>
            <span class="chip" data-f="cool">Cool</span>
            <span class="chip" data-f="film">Film</span>
            <span class="chip" data-f="matte">Matte</span>
          </div>
          <p class="text-xs text-slate-500">Presets setzen echte Werte; unten feinjustieren.</p>
        </div>

        <!-- Fine-tune -->
        <div class="space-y-3">
          <h3 class="text-lg font-semibold">Feinjustierung</h3>
          <label class="text-sm font-medium">Brightness <span id="valB" class="text-slate-500">100%</span></label>
          <input id="brightness" type="range" min="50" max="150" value="100" data-persist="img.brightness" />
          <label class="text-sm font-medium">Contrast <span id="valC" class="text-slate-500">100%</span></label>
          <input id="contrast" type="range" min="50" max="150" value="100" data-persist="img.contrast" />
          <label class="text-sm font-medium">Saturation <span id="valS" class="text-slate-500">100%</span></label>
          <input id="saturation" type="range" min="0" max="200" value="100" data-persist="img.saturation" />
        </div>

        <!-- Source -->
        <div class="space-y-2">
          <h3 class="text-lg font-semibold">Quelle</h3>
          <input id="file" type="file" accept="image/*" class="w-full" />
          <div class="flex items-center gap-2">
            <img id="thumb" class="thumb" src="https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=360&auto=format&fit=crop" alt="">
            <button id="btnReset" class="btn">Reset</button>
            <button id="btnDownload" class="btn">Download PNG</button>
          </div>
        </div>
      </aside>

      <!-- RIGHT: Preview -->
      <section class="space-y-4">
        <div class="bg-white rounded-xl shadow border p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">Preview</h3>
            <div id="meta" class="text-sm text-slate-500">—</div>
          </div>
          <canvas id="cv"></canvas>
        </div>
      </section>
    </div>
  </main>

  <script>
    // Canvas & Image
    const cv = document.getElementById('cv'), ctx = cv.getContext('2d');
    const img = new Image(); img.crossOrigin = 'anonymous';
    img.src = document.getElementById('thumb').src;
    const meta = document.getElementById('meta');
    const file = document.getElementById('file');

    // sliders + labels
    const brightness = document.getElementById('brightness');
    const contrast   = document.getElementById('contrast');
    const saturation = document.getElementById('saturation');
    const valB = document.getElementById('valB');
    const valC = document.getElementById('valC');
    const valS = document.getElementById('valS');

    // filters presets (gleiche Engine wie NSFW-Seite, andere Presets)
    const FILTERS = {
      none:    {brightness:100, contrast:100, saturation:100, extra:''},
      vintage: {brightness:105, contrast:95,  saturation:110, extra:'sepia(12%) hue-rotate(-5deg)'},
      sepia:   {brightness:100, contrast:100, saturation:95,  extra:'sepia(85%)'},
      noir:    {brightness:105, contrast:120, saturation:0,   extra:''},
      vibrant: {brightness:102, contrast:108, saturation:140, extra:''},
      warm:    {brightness:101, contrast:104, saturation:115, extra:'sepia(10%) hue-rotate(-8deg)'},
      cool:    {brightness:101, contrast:104, saturation:110, extra:'hue-rotate(12deg)'},
      film:    {brightness:98,  contrast:110, saturation:105, extra:''},
      matte:   {brightness:104, contrast:90,  saturation:95,  extra:''}
    };

    let activePreset = 'none';

    function applyPreset(name){
      activePreset = name;
      const p = FILTERS[name];
      brightness.value = p.brightness;
      contrast.value   = p.contrast;
      saturation.value = p.saturation;
      updateLabels();
      render();
      document.querySelectorAll('#filters .chip').forEach(c=>c.classList.toggle('active', c.dataset.f===name));
    }

    function fitCanvas() {
      const maxW = Math.min(960, cv.parentElement.clientWidth);
      const aspect = img.width / img.height || 16/9;
      const w = maxW, h = Math.round(w / aspect);
      cv.width = w; cv.height = h; cv.style.height = h+'px';
      meta.textContent = `${w}×${h}`;
    }

    function currentFilterCSS() {
      return `brightness(${brightness.value}%) contrast(${contrast.value}%) saturate(${saturation.value}%) ${FILTERS[activePreset].extra||''}`;
    }

    function updateLabels(){
      valB.textContent = brightness.value + '%';
      valC.textContent = contrast.value + '%';
      valS.textContent = saturation.value + '%';
    }

    function render(){
      if (!img.complete) return;
      fitCanvas();
      ctx.clearRect(0,0,cv.width,cv.height);
      ctx.filter = currentFilterCSS();
      ctx.drawImage(img, 0, 0, cv.width, cv.height);
      ctx.filter = 'none';
    }

    img.onload = render;
    window.addEventListener('resize', render);
    [brightness,contrast,saturation].forEach(s => s.addEventListener('input', ()=>{ updateLabels(); render(); }));
    updateLabels();

    document.getElementById('filters').addEventListener('click', e=>{
      const chip = e.target.closest('.chip'); if(!chip) return;
      applyPreset(chip.dataset.f);
    });
    applyPreset('none');

    file.addEventListener('change', e=>{
      const f = e.target.files?.[0]; if(!f) return;
      const url = URL.createObjectURL(f);
      img.onload = ()=>{ document.getElementById('thumb').src = url; render(); };
      img.src = url;
    });

    document.getElementById('btnReset').addEventListener('click', ()=>{
      applyPreset('none');
      document.getElementById('thumb').src = 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=360&auto=format&fit=crop';
      img.src = document.getElementById('thumb').src;
    });

    document.getElementById('btnDownload').addEventListener('click', ()=>{
      const a = document.createElement('a');
      a.href = cv.toDataURL('image/png'); a.download = 'image.png'; a.click();
    });

    // prompt demo submit
    const statusEl = document.getElementById('status');
    function show(msg, ok=true){ statusEl.textContent=msg; statusEl.className='text-sm '+(ok?'text-emerald-600':'text-rose-600'); }
    async function submit(){
      const payload = {
        prompt: document.getElementById('promptInput').value,
        negative: document.getElementById('neg').value,
        category: document.getElementById('categorySelect').value,
        aspect: document.getElementById('aspect').value,
        preset: activePreset,
        sliders: { brightness: +brightness.value, contrast:+contrast.value, saturation:+saturation.value }
      };
      show('Sende Job (Demo)…'); /* fetch('/api/image/generate', {method:'POST', body: JSON.stringify(payload)}) */
    }
    document.getElementById('btnGenerate').addEventListener('click', submit);
    document.getElementById('promptInput').addEventListener('keydown', e=>{ if(e.key==='Enter' && e.ctrlKey){ e.preventDefault(); submit(); }});
    document.getElementById('btnStop').addEventListener('click', ()=>show('Gestoppt.', false));
  </script>
</body>
</html>
