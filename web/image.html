<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>LocalMediaSuite – Image (SFW)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="assets/styles.css">
  <script defer src="assets/app.js"></script>
</head>
<body>
  <header>
    <h1 class="text-xl font-bold">LocalMediaSuite</h1>
    <nav class="flex gap-2 flex-wrap">
      <a href="index.html">Home</a>
      <a href="image.html" class="active">Image (SFW)</a>
      <a href="image_nsfw.html">Image (NSFW)</a>
      <a href="video.html">Video (SFW)</a>
      <a href="video_nsfw.html">Video (NSFW)</a>
      <a href="gallery.html">Gallery</a>
      <a href="catalog.html">Catalog</a>
      <a href="settings.html">Settings</a>
    </nav>
  </header>
  <main style="padding:2rem;max-width:1100px;margin:0 auto;">
    <form id="image-form" action="/api/generate/universal" method="POST" enctype="multipart/form-data" data-endpoint="/api/generate/universal">
      <!-- Hidden fields used by backend -->
      <input type="hidden" id="mode_input" name="mode" value="text2img">
      <input type="hidden" name="type" value="image">
      <h2 class="text-xl font-bold mb-4">Bildgenerator (SFW)</h2>
      <div class="generator-layout">
        <!-- Sidebar with settings -->
        <div class="sidebar flex flex-col gap-4" style="flex:0 0 320px;">
          <!-- Mode & model section -->
          <div class="card">
            <div class="mb-4">
              <label class="label" for="mode">Modus</label>
              <select id="mode" class="input" name="mode_select">
                <option value="text2img" selected>Text → Bild</option>
                <option value="img2img">Bild → Bild (Remix)</option>
              </select>
              <p class="text-sm text-muted mt-1">Wähle pro Lauf das gewünschte Verfahren. Der Model‑Picker passt sich automatisch an.</p>
            </div>
            <!-- Model tabs rendered via JS -->
            <div id="model-tabs" class=""></div>
          </div>
          <!-- Settings section -->
          <div class="card">
            <h3 class="text-md font-semibold mb-3">Einstellungen</h3>
            <div class="mb-3">
              <label class="label" for="resolution">Auflösung</label>
              <select id="resolution" class="input">
                <option value="768x768">768×768</option>
                <option value="1024x768" selected>1024×768</option>
                <option value="1536x1024">1536×1024</option>
                <option value="1024x1024">1024×1024</option>
                <option value="1920x1080">1920×1080</option>
              </select>
              <!-- Hidden numeric fields that will be populated based on resolution selection -->
              <input type="hidden" id="width_input" name="width" value="1024">
              <input type="hidden" id="height_input" name="height" value="768">
            </div>
            <div class="mb-3">
              <label class="label" for="format">Format</label>
              <select id="format" name="output_format" class="input">
                <option value="png">PNG</option>
                <option value="jpg" selected>JPG</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="label" for="jpg_quality">JPG‑Qualität</label>
              <input id="jpg_quality" class="input" type="number" name="jpg_quality" min="1" max="100" value="92">
            </div>
            <div class="mb-3">
              <label class="label" for="num_steps">Steps</label>
              <input id="num_steps" class="input" type="number" name="num_inference_steps" min="1" max="100" value="28">
            </div>
            <div class="mb-3">
              <label class="label" for="guidance">Guidance</label>
              <input id="guidance" class="input" type="number" step="0.1" name="guidance_scale" value="7.0">
            </div>
            <div>
              <label class="label" for="strength">Strength (nur Bild→Bild)</label>
              <input id="strength" class="input" type="number" step="0.01" min="0" max="1" name="strength" value="0.65">
            </div>
          </div>
          <!-- Categories & random prompt -->
          <div class="card">
            <h3 class="text-md font-semibold mb-3">Ideen & Kategorien</h3>
            <div class="flex gap-2 mb-2">
              <button type="button" id="btn-random" class="btn secondary w-full">Zufalls‑Prompt</button>
            </div>
            <div id="cat-chips" class="flex flex-wrap gap-2"></div>
          </div>
        </div>
        <!-- Main area with preview and inputs -->
        <div class="main-area flex flex-col gap-4" style="flex:1;">
          <!-- Large preview area for upload or generated image -->
          <div id="display-container" class="card hidden" style="min-height:360px; display:flex; align-items:center; justify-content:center;"></div>
          <div class="card flex flex-col gap-4">
            <!-- Prompt and suggestions -->
            <div>
              <label class="label" for="prompt">Prompt</label>
              <textarea id="prompt" name="prompt" class="input" rows="4" placeholder="Beschreibe das Bild..." required></textarea>
              <div id="prompt-suggestions" class="flex flex-wrap gap-2 mt-2"></div>
            </div>
            <!-- Upload/remix block -->
            <div id="init-block">
              <div class="mb-4">
                <label class="label" for="init_image">Upload (Eingangsbild)</label>
                <input id="init_image" class="input" type="file" name="init_image" accept="image/*">
                <p class="text-sm text-muted mt-1">Upload überschreibt Remix. Für Bild→Bild ist eines von beidem erforderlich.</p>
                <div id="preview-container" class="mt-2 hidden">
                  <img id="preview-img" src="" alt="Vorschau" style="max-width:100%; border-radius:0.5rem;">
                </div>
              </div>
              <div>
                <label class="label" for="remix">Remix (aus Galerie)</label>
                <select id="remix" class="input">
                  <option value="">— wählen —</option>
                </select>
                <input type="hidden" id="init_url" name="init_url">
              </div>
            </div>
            <!-- Buttons -->
            <div class="flex gap-3">
              <button type="submit" class="btn primary">Generieren</button>
              <button type="button" id="btn-clear" class="btn secondary">Prompt leeren</button>
            </div>
          </div>
        </div>
      </div><!-- end generator-layout -->
    </form>
  </main>
  <script>
  // Vorschau für hochgeladene Bilder
  document.addEventListener('DOMContentLoaded', function(){
    const fileInput = document.getElementById('init_image');
    const previewContainer = document.getElementById('preview-container');
    const previewImg = document.getElementById('preview-img');
    fileInput.addEventListener('change', function(){
      const file = this.files && this.files[0];
      const display = document.getElementById('display-container');
      if(file){
        const reader = new FileReader();
        reader.onload = function(e){
          previewImg.src = e.target.result;
          previewContainer.classList.remove('hidden');
          // populate large preview
          if(display){
            display.innerHTML = '';
            const imgEl = document.createElement('img');
            imgEl.src = e.target.result;
            imgEl.style.maxWidth = '100%';
            imgEl.style.borderRadius = '0.5rem';
            display.appendChild(imgEl);
            display.classList.remove('hidden');
          }
        };
        reader.readAsDataURL(file);
      } else {
        previewContainer.classList.add('hidden');
        previewImg.src = '';
        if(display){
          display.classList.add('hidden');
          display.innerHTML = '';
        }
      }
    });

    // Resolution handling: update hidden width/height fields when user selects a resolution
    const resSelect = document.getElementById('resolution');
    const widthField = document.getElementById('width_input');
    const heightField = document.getElementById('height_input');
    function updateResolution(){
      const parts = (resSelect.value || '').split('x');
      if(parts.length === 2){
        widthField.value = parseInt(parts[0]);
        heightField.value = parseInt(parts[1]);
      }
    }
    if(resSelect){
      resSelect.addEventListener('change', updateResolution);
      // Initialize on load
      updateResolution();
    }
  });
  </script>
  <script>
  // Hauptinitialisierung für Bildseite
  async function fetchSuggestions(domain, nsfw, purpose){
    const urls = [
      `/api/suggestions?domain=${domain}&nsfw=${nsfw}&purpose=${purpose}`,
      `/api/suggestions?type=${domain}&nsfw=${nsfw}&purpose=${purpose}`,
      `/api/suggestions?type=${domain}&nsfw=${nsfw}`
    ];
    for (const u of urls){ try{ const r = await fetch(u); if(r.ok) return await r.json(); }catch{} }
    // Fallbacks – Beispielideen
    if (purpose === 'img2img'){
      return {
        categories: [
          { id:'style', label:'Stil‑Remix', ideas:[
            'convert to moody cinematic look, chiaroscuro lighting, deep contrast',
            'convert to glossy editorial fashion, studio highlights, clean backdrop'
          ]},
          { id:'upscale', label:'Verbessern', ideas:[
            'refine details, sharpen textures, natural skin, reduce artifacts',
            'noise removal, color balance correction, realistic tone mapping'
          ]}
        ],
        modifiers: ['photorealistic, 8k details', 'clean color grade, subtle film grain']
      };
    } else {
      return {
        categories: [
          { id:'portrait', label:'Portrait', ideas:[
            'ultrarealistic studio portrait, soft light, 85mm lens, skin texture',
            'outdoor natural light portrait, shallow depth of field'
          ]},
          { id:'scene', label:'Szene', ideas:[
            'golden hour city street, wet asphalt reflections, cinematic',
            'modern interior, realistic materials, soft daylight'
          ]}
        ],
        modifiers: ['8k detailed, photorealistic', 'filmic grade, dynamic range']
      };
    }
  }
  
  async function fetchGalleryImages(){
    const urls = ['/api/files?type=image','/api/gallery?type=image','/api/files/images'];
    for (const u of urls){ try{ const r = await fetch(u); if(r.ok) return await r.json(); }catch{} }
    return [];
  }
  
  function pushPrompt(textarea, addition){
    const cur = textarea.value.trim();
    if (!cur) { textarea.value = addition; return; }
    if (!cur.toLowerCase().includes(addition.toLowerCase())){ textarea.value = cur + ', ' + addition; }
  }
  
  (async function(){
    const NSFW = false;
    let PURPOSE = 'text2img';
    const PAGE_KEY = () => `image:${PURPOSE}:${NSFW?'nsfw':'sfw'}`;

    async function loadAndRenderModels(){
      const models = await LMS.loadModels('image', NSFW, PURPOSE);
      const sel = LMS.getSelectedModel(PAGE_KEY());
      if(!sel && models.length) LMS.setSelectedModel(PAGE_KEY(), models[0].id);
      LMS.renderModelTabs({
        container: document.getElementById('model-tabs'),
        models,
        onSelect: (id)=> LMS.setSelectedModel(PAGE_KEY(), id),
        activeId: LMS.getSelectedModel(PAGE_KEY()),
        title: NSFW ? 'Kompatible Bild‑Modelle (NSFW‑geeignet)' : 'Kompatible Bild‑Modelle'
      });
    }

    async function loadAndRenderSuggestions(){
      const sug = await fetchSuggestions('image', NSFW, PURPOSE);
      const catWrap = document.getElementById('cat-chips');
      const ideasWrap = document.getElementById('prompt-suggestions');
      const txt = document.getElementById('prompt');
      catWrap.innerHTML = ''; ideasWrap.innerHTML = '';
      (sug.categories||[]).forEach(c=>{
        const b = document.createElement('button');
        b.type='button'; b.className='chip'; b.textContent=c.label;
        b.addEventListener('click', ()=>{
          ideasWrap.innerHTML='';
          (c.ideas||[]).forEach(p=>{
            const a=document.createElement('button');
            a.type='button'; a.className='btn ghost'; a.textContent=p;
            a.addEventListener('click', ()=> pushPrompt(txt, p));
            ideasWrap.appendChild(a);
          });
        });
        catWrap.appendChild(b);
      });
      document.getElementById('btn-random').onclick = ()=>{
        const cats = sug.categories||[]; if(!cats.length) return;
        const c = cats[Math.floor(Math.random()*cats.length)];
        const idea = (c.ideas||[])[Math.floor(Math.random()*(c.ideas||[]).length)] || '';
        const mod = (sug.modifiers||[])[Math.floor(Math.random()*(sug.modifiers||[]).length)] || '';
        const rp = [idea, mod].filter(Boolean).join(', ');
        if (rp) document.getElementById('prompt').value = rp;
      };

      // Auto-select first category to show its suggestions immediately
      const firstCatBtn = catWrap.querySelector('button');
      if(firstCatBtn){ firstCatBtn.click(); }
    }

    async function applyMode(){
      PURPOSE = modeSel.value;
      modeHidden.value = PURPOSE;
      initBlock.classList.toggle('hidden', PURPOSE !== 'img2img');
      await loadAndRenderModels();
      await loadAndRenderSuggestions();
    }
    
    // Hook up elements
    const modeSel = document.getElementById('mode');
    const modeHidden = document.getElementById('mode_input');
    const initBlock = document.getElementById('init-block');
    modeSel.addEventListener('change', applyMode);
    await applyMode();

    // Populate remix selector with gallery images
    (async () => {
      const remixSel = document.getElementById('remix');
      const initUrlInput = document.getElementById('init_url');
      if (remixSel) {
        try {
          const files = await fetchGalleryImages();
          (files.items || []).forEach(f => {
            const opt = document.createElement('option');
            opt.value = f.url || f.file || f.path || '';
            opt.textContent = f.name || opt.value.split('/').pop();
            remixSel.appendChild(opt);
          });
          remixSel.addEventListener('change', () => {
            initUrlInput.value = remixSel.value || '';
          });
        } catch (e) {
          console.warn('remix list failed', e);
        }
      }
    })();
    LMS.attachModelToForm(document.getElementById('image-form'), PAGE_KEY());
    document.getElementById('btn-clear').addEventListener('click', ()=>{ document.getElementById('prompt').value=''; });

    window.LMS.onGenerated = (url)=>{
      // Display generated image in large preview container
      const display = document.getElementById('display-container');
      if(display){
        display.innerHTML = '';
        const imgEl = document.createElement('img');
        imgEl.src = url;
        imgEl.style.maxWidth = '100%';
        imgEl.style.borderRadius = '0.5rem';
        display.appendChild(imgEl);
        display.classList.remove('hidden');
      }
      LMS.toast('Dein Bild wurde generiert und ist in der Galerie verfügbar.', 'success');
    };
  })();
  </script>
</body>
</html>