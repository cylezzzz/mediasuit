<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <title>LocalMediaSuite – Video (SFW)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="/assets/logo.ico">
  <link rel="stylesheet" href="/assets/styles.css">
</head>
<body class="bg-gray-900 text-gray-100">
  <header class="container mx-auto py-4 flex items-center justify-between">
    <div class="flex items-center gap-2">
      <img src="/assets/logo.svg" alt="logo" style="height:28px"/>
      <div class="font-semibold">LocalMediaSuite</div>
      <div class="text-xs text-gray-400">Video (SFW)</div>
    </div>
    <nav class="flex gap-3 text-sm">
      <a href="/index.html">Home</a>
      <a href="/image.html">Image (SFW)</a>
      <a href="/image_nsfw.html">Image (NSFW)</a>
      <a href="/video.html" class="text-blue-400">Video (SFW)</a>
      <a href="/video_nsfw.html" class="">Video (NSFW)</a>
      <a href="/gallery.html">Gallery</a>
      <a href="/catalog.html">Catalog</a>
      <a href="/settings.html">Settings</a>
    </nav>
  </header>

  <main class="container mx-auto px-3 pb-10">
    <!-- Modell-Tabs -->
    <div id="model-tabs" class="card mb-4"></div>

    <!-- Mode & Basics -->
    <div class="card mb-4">
      <div class="grid sm:grid-cols-3 gap-3">
        <div>
          <label class="label">Modus</label>
          <select id="mode" class="input w-full">
            <option value="text2video" selected>Text → Video</option>
            <option value="img2video">Bild → Video</option>
          </select>
        </div>
        <div class="sm:col-span-2 flex items-end justify-end">
          <div class="text-xs text-gray-400">Pro Lauf wählbar. Der Model-Picker passt sich automatisch an.</div>
        </div>
      </div>
    </div>

    <!-- Kategorien & Vorschläge -->
    <div class="grid md:grid-cols-3 gap-3 mb-4">
      <div class="card">
        <div class="font-semibold mb-2">Kategorien</div>
        <div id="cat-chips" class="flex flex-wrap gap-2"></div>
      </div>
      <div class="card md:col-span-2">
        <div class="flex items-center justify-between mb-2">
          <div class="font-semibold">Prompt-Vorschläge</div>
          <div class="flex items-center gap-2">
            <button id="btn-random" class="btn">Zufalls-Prompt</button>
            <span class="text-xs text-gray-400">SFW</span>
          </div>
        </div>
        <div id="prompt-suggestions" class="flex flex-wrap gap-2"></div>
      </div>
    </div>

    <!-- Generator-Form -->
    <form id="video-form" data-endpoint="/api/generate/video" class="card" enctype="multipart/form-data">
      <input type="hidden" name="mode" id="mode_input" value="text2video"/>
      <input type="hidden" name="nsfw" value="false"/>

      <div class="grid md:grid-cols-2 gap-3">
        <div>
          <label class="label">Prompt</label>
          <textarea id="prompt" name="prompt" rows="6" class="input w-full" placeholder="Beschreibe den Clip… (Startframe wird ggf. automatisch erzeugt)"></textarea>

          <div id="init-block" class="mt-3 grid grid-cols-2 gap-3 hidden">
            <div>
              <label class="label">Upload (Startbild)</label>
              <input type="file" name="init_image" accept="image/*" class="input w-full"/>
            </div>
            <div>
              <label class="label">Remix (aus Galerie)</label>
              <select id="remix" class="input w-full">
                <option value="">— wählen —</option>
              </select>
              <input type="hidden" name="init_url" id="init_url"/>
            </div>
          </div>
          <div class="text-xs text-gray-400 mt-1">Hinweis: Für <b>Bild→Video</b> ist Upload oder Remix erforderlich. Bei <b>Text→Video</b> wird die Startframe automatisch generiert.</div>
        </div>

        <div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="label">Auflösung</label>
              <select name="vid_resolution" class="input w-full">
                <option selected>1280x720</option>
                <option>1920x1080</option>
              </select>
            </div>
            <div>
              <label class="label">FPS</label>
              <input type="number" name="vid_fps" class="input w-full" min="12" max="60" value="24"/>
            </div>
            <div>
              <label class="label">Länge (Sek.)</label>
              <input type="number" name="vid_length_sec" class="input w-full" min="1" max="30" value="3"/>
            </div>
            <div>
              <label class="label">Frames (optional)</label>
              <input type="number" name="num_frames_override" class="input w-full" min="8" max="65" value="0"/>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4 flex items-center gap-2">
        <button class="btn primary" type="submit">Generieren</button>
        <button class="btn" type="button" id="btn-clear">Prompt leeren</button>
      </div>
    </form>

    <!-- Player -->
    <div id="last-output" class="card mt-4 hidden">
      <div class="font-semibold mb-2">Ergebnis</div>
      <video id="last-vid" class="w-full rounded" controls autoplay></video>
    </div>
  </main>

  <script src="/assets/app.js"></script>
  <script>
  async function fetchSuggestions(domain, nsfw, purpose){{
    const urls = [
      `/api/suggestions?domain=${{domain}}&nsfw=${{nsfw}}&purpose=${{purpose}}`,
      `/api/suggestions?type=${{domain}}&nsfw=${{nsfw}}&purpose=${{purpose}}`,
      `/api/suggestions?type=${{domain}}&nsfw=${{nsfw}}`
    ];
    for (const u of urls){{ try{{ const r=await fetch(u); if(r.ok) return await r.json(); }}catch{{}} }}
    if (purpose === "img2video"){{
      return {{
        categories: [
          {{ id:"motion", label:"Bewegung", ideas:[
            "gentle camera drift, subtle parallax, natural motion blur",
            "slow pan with subject movement, cinematic grading"
          ]}},
          {{ id:"detail", label:"Detail", ideas:[
            "macro motion of textures, shallow depth of field",
            "close-up highlights, specular motion, HDR look"
          ]}}
        ],
        modifiers: ["cinematic motion grade, filmic grain", "HDR range, natural blur trails"]
      }};
    }} else {{
      return {{
        categories: [
          {{ id:"cinematic", label:"Cinematic", ideas:[
            "cinematic car driving at sunset, aerial parallax, lens flares",
            "forest canopy wind movement, volumetric light rays"
          ]}},
          {{ id:"nature", label:"Nature", ideas:[
            "ocean waves closeup, foam details, stabilized handheld look",
            "waterfall slow motion, mist particles"
          ]}}
        ],
        modifiers: ["cinematic color grade, motion blur natural", "subtle film grain, high dynamic range"]
      }};
    }}
  }}

  async function fetchGalleryImages(){{
    const urls = ['/api/files?type=image','/api/gallery?type=image','/api/files/images'];
    for (const u of urls){{ try{{ const r=await fetch(u); if(r.ok) return await r.json(); }}catch{{}} }}
    return [];
  }}

  function pushPrompt(textarea, addition){{
    const cur = textarea.value.trim();
    if (!cur) {{ textarea.value = addition; return; }}
    if (!cur.toLowerCase().includes(addition.toLowerCase())){{ textarea.value = cur + ", " + addition; }}
  }}

  (async function(){{
    const NSFW = false;
    let PURPOSE = "text2video";
    const PAGE_KEY = () => `video:${{PURPOSE}}:${{NSFW?'nsfw':'sfw'}}`;

    async function loadAndRenderModels(){{
      const models = await LMS.loadModels('video', NSFW, PURPOSE);
      const sel = LMS.getSelectedModel(PAGE_KEY());
      if(!sel && models.length) LMS.setSelectedModel(PAGE_KEY(), models[0].id);
      LMS.renderModelTabs({{
        container: document.getElementById('model-tabs'),
        models,
        onSelect: (id)=> LMS.setSelectedModel(PAGE_KEY(), id),
        activeId: LMS.getSelectedModel(PAGE_KEY()),
        title: NSFW ? "Kompatible Video-Modelle (NSFW-geeignet)" : "Kompatible Video-Modelle (SVD)"
      }});
    }}

    async function loadAndRenderSuggestions(){{
      const sug = await fetchSuggestions('video', NSFW, PURPOSE);
      const catWrap = document.getElementById('cat-chips');
      const ideasWrap = document.getElementById('prompt-suggestions');
      const txt = document.getElementById('prompt');
      catWrap.innerHTML = ''; ideasWrap.innerHTML='';
      (sug.categories||[]).forEach(c=>{{
        const b = document.createElement('button');
        b.type='button'; b.className='chip'; b.textContent=c.label;
        b.addEventListener('click', ()=>{{
          ideasWrap.innerHTML='';
          (c.ideas||[]).forEach(p=>{{
            const a=document.createElement('button');
            a.type='button'; a.className='btn ghost'; a.textContent=p;
            a.addEventListener('click', ()=> pushPrompt(txt, p));
            ideasWrap.appendChild(a);
          }});
        }});
        catWrap.appendChild(b);
      }});
      document.getElementById('btn-random').onclick = ()=>{{
        const cats = sug.categories||[]; if(!cats.length) return;
        const c = cats[Math.floor(Math.random()*cats.length)];
        const idea = (c.ideas||[])[Math.floor(Math.random()*(c.ideas||[]).length)] || '';
        const mod = (sug.modifiers||[])[Math.floor(Math.random()*(sug.modifiers||[]).length)] || '';
        const rp = [idea, mod].filter(Boolean).join(', ');
        if (rp) document.getElementById('prompt').value = rp;
      }};
    }}

    // Remix populate
    (async ()=>{{
      const remixSel = document.getElementById('remix');
      const initUrl = document.getElementById('init_url');
      if (remixSel){{
        try{{ const files = await fetchGalleryImages();
          (files||[]).forEach(f=>{{
            const o = document.createElement('option');
            o.value = f.url || f.file || f.path || '';
            o.textContent = f.name || o.value.split('/').pop();
            remixSel.appendChild(o);
          }});
          remixSel.addEventListener('change', ()=>{{ initUrl.value = remixSel.value || ''; }});
        }}catch(e){{ console.warn('remix list failed', e); }}
      }}
    }})();

    const modeSel = document.getElementById('mode');
    const modeHidden = document.getElementById('mode_input');
    const initBlock = document.getElementById('init-block');

    async function applyMode(){{
      PURPOSE = modeSel.value;
      modeHidden.value = PURPOSE;
      initBlock.classList.toggle('hidden', PURPOSE !== 'img2video');
      await loadAndRenderModels();
      await loadAndRenderSuggestions();
    }}

    modeSel.addEventListener('change', applyMode);
    await applyMode();

    LMS.attachModelToForm(document.getElementById('video-form'), PAGE_KEY());
    document.getElementById('btn-clear').addEventListener('click', ()=>{{ document.getElementById('prompt').value=''; }});

    window.LMS.onGenerated = (url)=>{{
      const box = document.getElementById('last-output');
      const vid = document.getElementById('last-vid');
      vid.src = url; vid.play();
      box.classList.remove('hidden');
    }};
  }})();
  </script>
</body>
</html>
